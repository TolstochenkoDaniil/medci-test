# Описание

**Общее описание**: Необходимо реализовать сервис принимающий `http-запросы` на отправку сообщений через один из внешних сервисов со своим `api`. Т.е. сервис принимает запрос с сообщением и отправляет его в один из следующих шлюзов.

**Описание результата**:

Сервис имеет один ендпоинт `/send_message`, принимающий `POST`-запросы на отправку сообщения в виде json:

Пример

```js
{
    'message': 'hello world', 
    'gateway': 'gateway_1'
}
```

`gateway` имеет два возможных варианта `gateway_1` и `gateway_2`.
Если сообщение принято к отправке, возвращается код `200`.
Сообщение из запроса отправляется в шлюз. Каждый шлюз принимает post-запрос в формате `json`. `URL` шлюза выбрать произвольный.
Формат запроса к шлюзу:

```js
{
    'message': str
}
```

Дополнительно предусмотреть:

1. Отправка сообщения должна быть обработана даже если шлюз недоступен в данный момент (максимум три попытки отправки с интервалом не менее чем 1 мин)
2. Количество шлюзов может увеличиваться
3. Возможность работы со шлюзами имеющими разные форматы запроса

Ограничения:

1. Можно использовать любой удобный фреймворк на python
2. Без брокеров сообщений

## Реализация

- Использованый фреймворк: `Flask`
- Шлюзы `gateway` реализованы в том же приложении, что и основной эндпоинт для простоты выполнения тестового задания
- Основной `url` шлюзов определяется настройками, если появятся новые эндпоинты будет возможен доступ
- Ответ от основного эндпоинта возвращается моментально, если данные переданы верно
- Ответ запроса к `gateway` эндпоинтам не ожидается
- В случаях, когда сервер `gateway` недоступен(ошибка подключения, код ответа отличный от 2хх), происходит перезапрос, каждую минуту, в целом производится не более 3 запросов, включая начальный
- **НЕ** реализован п.3: `Возможность работы со шлюзами имеющими разные форматы запроса`

## Запуск

1. Скачать репозиторий

   ```sh
   git clone <git_url>
   ```

2. Собрать образ

   ```sh
   docker built . -t test-app
   ```

3. Запустить приложение

   ```sh
   docker run --name test_app --publish 5000:5000 --rm test-app
   ```

## Тесты

1. При запущенном приложении

   ```sh
   docker exec -it test_app pytest
   ```

## Работа приложения

При запущенном приложении выполнить

```sh
curl -v -X POST http://0.0.0.0:5000/send_message -d '{"message": "test", "gateway": "gateway_1"}'
```

или

```sh
curl -v -X POST http://0.0.0.0:5000/send_message -d '{"message": "test", "gateway": "gateway_2"}'
```

### Ответ

> [2021-08-26 11:20:37 +0000] [9] [DEBUG] POST /send_message  
> [2021-08-26 11:20:37 +0000] [7] [DEBUG] POST /gateway_1

Для недоступного эндпоинта

```sh
curl -v -X POST http://0.0.0.0:5000/send_message -d '{"message": "test", "gateway": "gateway_99"}'
```

### Ответ

> [2021-08-26 11:22:11 +0000] [7] [DEBUG] POST /send_message  
> [2021-08-26 11:22:11 +0000] [7] [DEBUG] POST /gateway_99  
> [2021-08-26 11:23:11 +0000] [9] [DEBUG] POST /gateway_99  
> [2021-08-26 11:24:11 +0000] [9] [DEBUG] POST /gateway_99
